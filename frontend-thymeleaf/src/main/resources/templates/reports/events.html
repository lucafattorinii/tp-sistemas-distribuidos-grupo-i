<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe de Participaci√≥n en Eventos - Sistema de Gesti√≥n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        .nav-link.active { background-color: #0d6efd; color: white; }
        .card { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .event-card {
            border-left: 4px solid #ffc107;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .filter-card {
            border-left: 4px solid #17a2b8;
        }
        .success-message {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="status-badge">üü¢ Sistema Activo - Informes GraphQL</div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <div style="padding: 20px; text-align: center;">
                        <h6>üöÄ Sistema de Gesti√≥n</h6>
                        <small class="text-muted">TP3 - GraphQL & REST</small>
                    </div>
                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/">Inicio</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/users">Usuarios</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/inventory">Inventario</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/events">Eventos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/events/externos">Eventos Externos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/reports/donations">üìä Informe Donaciones</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/reports/events">üìà Informe Eventos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/soap/presidents">üë• Consulta SOAP</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">üìà Informe de Participaci√≥n en Eventos</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-success" onclick="exportToExcel()">üì• Excel</button>
                            <button type="button" class="btn btn-sm btn-primary" onclick="saveCustomFilter()">üíæ Guardar Filtro</button>
                            <button type="button" class="btn btn-sm btn-info" onclick="loadFilters()">üìÇ Mis Filtros</button>
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card filter-card">
                            <div class="card-header">
                                <h6>üîç Filtros de B√∫squeda</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-2">
                                        <label for="startDateFilter" class="form-label">Fecha Desde *</label>
                                        <input type="date" class="form-control" id="startDateFilter" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="endDateFilter" class="form-label">Fecha Hasta *</label>
                                        <input type="date" class="form-control" id="endDateFilter" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="userFilter" class="form-label">Usuario</label>
                                        <select class="form-select" id="userFilter">
                                            <option value="">Todos los usuarios</option>
                                            <option value="1">Juan P√©rez</option>
                                            <option value="2">Mar√≠a Gonz√°lez</option>
                                            <option value="3">Carlos Rodr√≠guez</option>
                                            <option value="4">Ana L√≥pez</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="donationFilter" class="form-label">Con Donaciones</label>
                                        <select class="form-select" id="donationFilter">
                                            <option value="">Ambos</option>
                                            <option value="true">Con donaciones</option>
                                            <option value="false">Sin donaciones</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <div>
                                            <button type="button" class="btn btn-primary" onclick="applyFilters()">üîç Buscar</button>
                                            <button type="button" class="btn btn-secondary" onclick="clearFilters()">üóëÔ∏è Limpiar</button>
                                            <button type="button" class="btn btn-success btn-sm" onclick="saveCurrentFilter()">üíæ Guardar Filtros</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros Guardados -->
                <div class="row mb-4" id="savedFiltersSection" style="display: none;">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6>üíæ Filtros Personalizados</h6>
                                <div>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="toggleSavedFilters()">üëÅÔ∏è Ver/Ocultar</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="savedFiltersList">
                                    <!-- Aqu√≠ se mostrar√°n los filtros guardados -->
                                </div>
                                <div id="saveFilterForm" style="display: none;">
                                    <div class="mb-3">
                                        <label for="filterName" class="form-label">Nombre del Filtro</label>
                                        <input type="text" class="form-control" id="filterName" placeholder="Ej: Eventos con Donaciones">
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="confirmSaveFilter()">‚úÖ Guardar</button>
                                    <button type="button" class="btn btn-secondary" onclick="cancelSaveFilter()">‚ùå Cancelar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>üìã Eventos Participados</h5>
                                <span class="badge bg-info" id="resultsCount">0 eventos</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped" id="eventsTable">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Evento</th>
                                                <th>Descripci√≥n</th>
                                                <th>Con Donaciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="eventsTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <h6>üîß Informaci√≥n T√©cnica - GraphQL</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Query:</strong><br>
                                        <code>eventParticipationReport(input: {...})</code><br>
                                        <strong>Endpoint:</strong> http://localhost:8085/graphql
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Caracter√≠sticas:</strong><br>
                                        - Filtros por fechas obligatorios<br>
                                        - Participaci√≥n en eventos<br>
                                        - Estad√≠sticas b√°sicas
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentFilters = {};
        let savedFilters = [];

        function applyFilters() {
            const startDate = document.getElementById('startDateFilter').value;
            const endDate = document.getElementById('endDateFilter').value;

            if (!startDate || !endDate) {
                alert('‚ö†Ô∏è Las fechas son obligatorias');
                return;
            }

            currentFilters = {
                startDate: startDate,
                endDate: endDate,
                userId: document.getElementById('userFilter').value,
                hasDonationDistribution: document.getElementById('donationFilter').value
            };

            console.log('Aplicando filtros:', currentFilters);
            loadEventData(currentFilters);
        }

        function loadEventData(filters) {
            const mockData = [
                {
                    year: 2024,
                    month: 12,
                    eventDate: '2024-12-15T10:00:00',
                    eventName: 'Colecta de Alimentos',
                    eventDescription: 'Recolecci√≥n de alimentos no perecederos',
                    hasDonationDistribution: true,
                    participants: ['Mar√≠a Gonz√°lez', 'Carlos Rodr√≠guez']
                },
                {
                    year: 2024,
                    month: 12,
                    eventDate: '2024-12-20T14:00:00',
                    eventName: 'Jornada de Voluntariado',
                    eventDescription: 'Actividades comunitarias',
                    hasDonationDistribution: false,
                    participants: ['Ana L√≥pez', 'Juan P√©rez', 'Laura Mart√≠nez']
                }
            ];

            displayResults(mockData);
        }

        function displayResults(data) {
            document.getElementById('resultsCount').textContent = `${data.length} eventos`;

            const eventsByMonth = {};
            data.forEach(event => {
                const key = `${event.year}-${String(event.month).padStart(2, '0')}`;
                if (!eventsByMonth[key]) {
                    eventsByMonth[key] = [];
                }
                eventsByMonth[key].push(event);
            });

            displayMonthlyEvents(eventsByMonth);

            displayEventsTable(data);
        }

        function displayMonthlyEvents(eventsByMonth) {
            const container = document.createElement('div');
            container.className = 'row mb-4';
            container.innerHTML = '';

            Object.entries(eventsByMonth).forEach(([monthYear, events]) => {
                const [year, month] = monthYear.split('-');
                const monthName = new Date(year, month - 1).toLocaleString('es', { month: 'long', year: 'numeric' });

                const monthDiv = document.createElement('div');
                monthDiv.className = 'mb-4';
                monthDiv.innerHTML = `
                    <h5 class="text-primary mb-3">üìÖ ${monthName}</h5>
                    <div class="row">
                        ${events.map(event => `
                            <div class="col-md-6 mb-3">
                                <div class="card event-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6>${event.eventName}</h6>
                                                <p class="mb-2">${event.eventDescription}</p>
                                                <small>üìÖ ${new Date(event.eventDate).toLocaleDateString()}</small><br>
                                                <small>üë• ${event.participants.length} participantes</small><br>
                                                <small>${event.hasDonationDistribution ? 'üéÅ Con donaciones' : 'üìã Sin donaciones'}</small>
                                            </div>
                                            <span class="badge bg-light text-dark">${event.participants.length}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                const resultsCard = document.querySelector('.card');
                if (resultsCard && !resultsCard.querySelector('.row.mb-4')) {
                    resultsCard.insertBefore(monthDiv, resultsCard.firstChild);
                }
            });
        }

        function displayEventsTable(data) {
            const tbody = document.getElementById('eventsTableBody');
            tbody.innerHTML = '';

            data.forEach(event => {
                const row = document.createElement('tr');
                const monthYear = `${event.year}-${String(event.month).padStart(2, '0')}`;
                row.innerHTML = `
                    <td>${monthYear}</td>
                    <td>${new Date(event.eventDate).toLocaleDateString()}</td>
                    <td>${event.eventName}</td>
                    <td>${event.eventDescription}</td>
                    <td><span class="badge ${event.hasDonationDistribution ? 'bg-success' : 'bg-secondary'}">
                        ${event.hasDonationDistribution ? 'S√≠' : 'No'}</span></td>
                    <td>${event.participants.join(', ')}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function clearFilters() {
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            document.getElementById('userFilter').value = '';
            document.getElementById('donationFilter').value = '';
            currentFilters = {};
        }

        function saveCurrentFilter() {
            if (Object.keys(currentFilters).length === 0) {
                alert('‚ö†Ô∏è Debe aplicar filtros antes de guardarlos');
                return;
            }

            const form = document.getElementById('saveFilterForm');
            const list = document.getElementById('savedFiltersList');

            list.style.display = 'none';
            form.style.display = 'block';
        }

        function cancelSaveFilter() {
            const form = document.getElementById('saveFilterForm');
            const list = document.getElementById('savedFiltersList');

            form.style.display = 'none';
            list.style.display = 'block';
            document.getElementById('filterName').value = '';
        }

        function confirmSaveFilter() {
            const filterName = document.getElementById('filterName').value.trim();

            if (!filterName) {
                alert('‚ö†Ô∏è Debe ingresar un nombre para el filtro');
                return;
            }

            alert(`üíæ Filtro "${filterName}" guardado exitosamente!\n\nFiltros aplicados:\n${JSON.stringify(currentFilters, null, 2)}`);

            cancelSaveFilter();
            loadSavedFilters();
        }

        function toggleSavedFilters() {
            const section = document.getElementById('savedFiltersSection');
            const button = event.target;

            if (section.style.display === 'none') {
                section.style.display = 'block';
                button.textContent = 'üëÅÔ∏è Ocultar';
                loadSavedFilters();
            } else {
                section.style.display = 'none';
                button.textContent = 'üëÅÔ∏è Ver';
            }
        }

        function loadSavedFilters() {
            savedFilters = [
                { id: 1, name: 'Eventos con Donaciones', filterType: 'EVENT_PARTICIPATION', hasDonationDistribution: true },
                { id: 2, name: 'Mi Participaci√≥n', filterType: 'EVENT_PARTICIPATION', userId: '1' }
            ];

            const container = document.getElementById('savedFiltersList');
            container.innerHTML = '';

            if (savedFilters.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay filtros guardados</p>';
                return;
            }

            savedFilters.forEach(filter => {
                const div = document.createElement('div');
                div.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
                div.innerHTML = `
                    <div>
                        <strong>${filter.name}</strong><br>
                        <small class="text-muted">${JSON.stringify(filter)}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-primary me-1" onclick="applySavedFilter(${filter.id})">üîç Usar</button>
                        <button class="btn btn-sm btn-warning me-1" onclick="editSavedFilter(${filter.id})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSavedFilter(${filter.id})">üóëÔ∏è Eliminar</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function applySavedFilter(filterId) {
            const filter = savedFilters.find(f => f.id === filterId);
            if (filter) {
                document.getElementById('startDateFilter').value = filter.startDate || '';
                document.getElementById('endDateFilter').value = filter.endDate || '';
                document.getElementById('userFilter').value = filter.userId || '';
                document.getElementById('donationFilter').value = filter.hasDonationDistribution !== undefined ? filter.hasDonationDistribution.toString() : '';

                currentFilters = { ...filter };
                applyFilters();
            }
        }

        function editSavedFilter(filterId) {
            alert(`‚úèÔ∏è Editando filtro ${filterId}\n\nFunci√≥n a implementar con mutaci√≥n GraphQL updateCustomFilter`);
        }

        function deleteSavedFilter(filterId) {
            if (confirm('¬øEst√° seguro de eliminar este filtro?')) {
                alert(`üóëÔ∏è Eliminando filtro ${filterId}\n\nFunci√≥n a implementar con mutaci√≥n GraphQL deleteCustomFilter`);
                loadSavedFilters();
            }
        }

        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

        document.getElementById('startDateFilter').value = firstDay.toISOString().split('T')[0];
        document.getElementById('endDateFilter').value = lastDay.toISOString().split('T')[0];

        applyFilters();
    </script>
</body>
</html>
